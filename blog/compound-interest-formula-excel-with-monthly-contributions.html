<!doctype html>
<html lang="en-IN">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Compound Interest Formula in Excel (with Monthly Contributions) | Calculator + Templates | CalculateForMe</title>
  <meta name="description" content="Learn the exact Excel formulas for compound interest with monthly contributions. Includes FV, PMT, NPER, RATE examples, a free online calculator, amortization schedule, and CSV download.">
  <link rel="canonical" href="https://calculateforme.xyz/blog/compound-interest-formula-excel-with-monthly-contributions">
  <meta name="keywords" content="compound interest Excel, Excel FV formula, Excel PMT, Excel NPER, Excel RATE, monthly contributions, step-up SIP, effective annual rate, begin of period, end of period, India calculator">
  <meta name="robots" content="index,follow">
  <meta name="theme-color" content="#0d6efd">
  <link rel="icon" href="https://calculateforme.xyz/favicon.png" type="image/png">
  <meta property="og:type" content="article">
  <meta property="og:title" content="Compound Interest Formula in Excel (with Monthly Contributions) | Calculator + Templates | CalculateForMe">
  <meta property="og:description" content="Exact Excel formulas (FV, PMT, NPER, RATE) for monthly contributions + an interactive calculator with schedule and CSV export.">
  <meta property="og:url" content="https://calculateforme.xyz/blog/compound-interest-formula-excel-with-monthly-contributions">
  <meta property="og:site_name" content="CalculateForMe">
  <meta property="og:image" content="https://calculateforme.xyz/images/compound-interest-excel-2025.jpg">
  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:title" content="Compound Interest Formula in Excel (with Monthly Contributions)">
  <meta name="twitter:description" content="Free calculator + copy-paste Excel formulas for compound interest with monthly contributions (FV, PMT, NPER, RATE).">
  <meta name="twitter:image" content="https://calculateforme.xyz/images/compound-interest-excel-2025.jpg">

  <script type="application/ld+json">
  {
    "@context": "https://schema.org",
    "@graph": [
      {
        "@type": "WebPage",
        "name": "Compound Interest in Excel (with Monthly Contributions)",
        "description": "Exact Excel formulas (FV, PMT, NPER, RATE) and an interactive calculator that supports step-up, different compounding, schedule and CSV.",
        "inLanguage": "en-IN",
        "url": "https://calculateforme.xyz/blog/compound-interest-formula-excel-with-monthly-contributions",
        "isPartOf": {
          "@type": "WebSite",
          "name": "CalculateForMe",
          "url": "https://calculateforme.xyz/"
        },
        "publisher": {
          "@type": "Organization",
          "name": "CalculateForMe",
          "logo": {
            "@type": "ImageObject",
            "url": "https://calculateforme.xyz/favicon.png"
          }
        }
      },
      {
        "@type": "BreadcrumbList",
        "itemListElement": [
          {"@type": "ListItem", "position": 1, "name": "Home", "item": "https://calculateforme.xyz/"},
          {"@type": "ListItem", "position": 2, "name": "Calculators", "item": "https://calculateforme.xyz/calculators.html"},
          {"@type": "ListItem", "position": 3, "name": "Compound Interest in Excel", "item": "https://calculateforme.xyz/blog/compound-interest-formula-excel-with-monthly-contributions"}
        ]
      },
      {
        "@type": "FAQPage",
        "mainEntity": [
          {
            "@type": "Question",
            "name": "What is the Excel formula for compound interest with monthly contributions?",
            "acceptedAnswer": {"@type": "Answer", "text": "Use FV with monthly rate and periods: =FV(rate/12, years*12, -monthly, -principal, type)."}
          },
          {
            "@type": "Question",
            "name": "Should I use FV or PMT for monthly investing?",
            "acceptedAnswer": {"@type": "Answer", "text": "Use FV to grow a known monthly contribution; use PMT to solve the monthly amount needed to reach a target."}
          },
          {
            "@type": "Question",
            "name": "How do I calculate the interest rate from a target maturity (RATE)?",
            "acceptedAnswer": {"@type": "Answer", "text": "Use RATE with monthly periods and multiply by 12 for annualized: =RATE(years*12, -monthly, -principal, target, type)*12."}
          },
          {
            "@type": "Question",
            "name": "How do I find years needed to reach a goal (NPER)?",
            "acceptedAnswer": {"@type": "Answer", "text": "NPER returns number of monthly periods. Divide by 12 for years: =NPER(rate/12, -monthly, -principal, target, type)/12."}
          },
          {
            "@type": "Question",
            "name": "How to handle beginning vs end-of-month contributions in Excel?",
            "acceptedAnswer": {"@type": "Answer", "text": "Set type to 1 for beginning-of-month (due) and 0 for end-of-month (ordinary). Beginning grows faster."}
          },
          {
            "@type": "Question",
            "name": "What’s the difference between nominal APR and effective annual rate?",
            "acceptedAnswer": {"@type": "Answer", "text": "APR ignores compounding within the year. EAR includes it: EAR=(1+r/m)^m-1. Use EAR when comparing products."}
          }
        ]
      }
    ]
  }
  </script>

  <style>
    :root{--blue:#0d6efd;--green:#20c997;--border:#e2e8f0;--text:#1f2937;--muted:#64748b;--bg:#ffffff}
    *{box-sizing:border-box}
    html,body{margin:0;padding:0;background:#fff;color:var(--text);font:16px/1.5 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,sans-serif}
    a{color:var(--blue);text-decoration:none}
    a:hover{opacity:.85}
    .container{max-width:1100px;margin:0 auto;padding:0 16px}
    .card{background:#fff;border:1px solid var(--border);border-radius:14px;box-shadow:0 2px 10px rgba(0,0,0,.04);padding:16px}
    .stack{display:grid;gap:16px}

    /* NAV */
    .nav{position:sticky;top:0;z-index:1000;background:var(--blue);color:#fff}
    .nav-wrap{display:flex;align-items:center;justify-content:space-between;gap:12px;padding:10px 0}
    .brand{font-weight:700}
    .nav-links{display:flex;gap:12px;flex-wrap:wrap}
    .nav a{color:#fff;font-weight:500}
    .nav a:focus{outline:3px solid #fff;outline-offset:2px}

    /* HERO */
    .hero{background:#e9f0ff;padding:28px 0}
    .hero h1{margin:0 0 6px;font-size:clamp(22px,4vw,32px);color:var(--blue)}
    .hero p{margin:0 0 12px;color:#0b1220}
    .btn{display:inline-flex;align-items:center;justify-content:center;min-height:44px;padding:.6rem 1rem;border-radius:999px;border:1px solid var(--blue);background:var(--blue);color:#fff;cursor:pointer;font-weight:600}
    .btn.secondary{background:#fff;color:var(--blue)}
    .btn:disabled{opacity:.5;cursor:not-allowed}

    /* GRID */
    .grid{display:grid;gap:16px}
    @media(min-width:900px){.grid-2{grid-template-columns:1.1fr .9fr}}

    /* FORM */
    form label{font-weight:600;color:var(--blue);display:block;margin-bottom:4px}
    form input,form select{width:100%;padding:.55rem .6rem;border:1px solid var(--border);border-radius:10px;font-size:15px}
    .row{display:grid;gap:12px;grid-template-columns:repeat(auto-fit,minmax(200px,1fr))}
    .help{font-size:12px;color:var(--muted)}
    .err{font-size:12px;color:#b91c1c}

    /* KPIs */
    .kpis{display:grid;gap:12px;grid-template-columns:repeat(auto-fit,minmax(220px,1fr))}
    .kpi{border:1px solid var(--border);border-radius:12px;padding:12px}
    .kpi .label{font-size:12px;color:var(--muted)}
    .kpi .value{font-size:20px;font-weight:700;color:#0b1220}

    /* Bars */
    #bars{display:flex;gap:8px;align-items:flex-end;margin-top:8px}
    .bar{flex:1;background:#f1f5f9;height:12px;border-radius:6px;overflow:hidden}
    .bar>span{display:block;height:100%;background:var(--blue);width:0;transition:width .4s}
    .bar.green>span{background:var(--green)}

    /* Table */
    .table-wrap{overflow:auto;border:1px solid var(--border);border-radius:12px}
    table{width:100%;border-collapse:separate;border-spacing:0;min-width:720px}
    caption{padding:10px;font-weight:600;text-align:left;color:var(--blue)}
    th,td{padding:10px;border-top:1px solid var(--border)}
    thead th{position:sticky;top:0;background:#fff;z-index:1;border-top:none}
    tbody tr:nth-child(odd){background:#fafafa}

    /* Pagination */
    .pager{display:flex;align-items:center;gap:8px;justify-content:flex-end;margin-top:8px}
    .pager button{min-height:36px;padding:0 .8rem;border-radius:8px;border:1px solid var(--border);background:#fff;cursor:pointer}

    /* Cards spacing */
    section{margin:24px 0}
    h2{color:var(--blue);margin:0 0 8px}

    /* Print */
    @media print{
      .nav,.hero,.cta-banner,.pager,.cta-links{display:none!important}
      body{font-size:12px}
      .card{box-shadow:none;border:none}
    }
  </style>
</head>
<body>
  <!-- 1) STICKY NAV -->
  <nav class="nav" aria-label="Primary">
    <div class="container nav-wrap">
      <div class="brand">CalculateForMe</div>
      <div class="nav-links" role="navigation">
        <a href="#calculator">Calculator</a>
        <a href="#excel">Excel</a>
        <a href="#guide">Guide</a>
        <a href="#faqs">FAQs</a>
      </div>
    </div>
  </nav>

  <!-- 2) HERO -->
  <header class="hero">
    <div class="container stack">
      <h1>Compound Interest in Excel (Monthly Contributions)</h1>
      <p>Exact Excel formulas + an interactive calculator for principal, monthly contributions, and growth. Includes schedule & CSV.</p>
      <div style="display:flex;gap:8px;flex-wrap:wrap">
        <button class="btn" id="cta-open">Open Calculator</button>
        <button class="btn secondary" id="cta-excel">Copy Excel Formulas</button>
      </div>
    </div>
  </header>

  <!-- 3) CALCULATOR -->
  <section id="calculator" class="container">
    <div class="card grid grid-2" aria-labelledby="calc-title">
      <div>
        <h2 id="calc-title">Calculator</h2>
        <form id="calcForm" novalidate>
          <div class="row">
            <div>
              <label for="principal">Principal / Starting Amount (₹)</label>
              <input type="number" id="principal" value="100000" min="0" step="100" aria-describedby="h-principal">
              <div id="h-principal" class="help">Amount you invest upfront (can be 0).</div>
              <div class="err" id="e-principal"></div>
            </div>
            <div>
              <label for="monthly">Monthly Contribution (₹)</label>
              <input type="number" id="monthly" value="5000" min="0" step="100" aria-describedby="h-monthly">
              <div id="h-monthly" class="help">Amount you add every month (SIP).</div>
              <div class="err" id="e-monthly"></div>
            </div>
            <div>
              <label for="rate">Annual Interest Rate (%)</label>
              <input type="number" id="rate" value="10" min="0" max="30" step="0.1" aria-describedby="h-rate">
              <div id="h-rate" class="help">Nominal APR; we adjust for compounding frequency.</div>
              <div class="err" id="e-rate"></div>
            </div>
            <div>
              <label for="compFreq">Compounding Frequency</label>
              <select id="compFreq" aria-describedby="h-comp">
                <option value="12" selected>Monthly (12)</option>
                <option value="4">Quarterly (4)</option>
                <option value="1">Yearly (1)</option>
              </select>
              <div id="h-comp" class="help">How often interest is added to balance.</div>
            </div>
            <div>
              <label for="when">Contribution Timing</label>
              <select id="when" aria-describedby="h-when">
                <option value="0" selected>End of month (type=0)</option>
                <option value="1">Beginning of month (type=1)</option>
              </select>
              <div id="h-when" class="help">Beginning grows faster as each payment earns an extra month.</div>
            </div>
            <div>
              <label for="years">Years</label>
              <input type="number" id="years" value="10" min="0" max="50" step="1" aria-describedby="h-years">
              <div id="h-years" class="help">Investment duration.</div>
              <div class="err" id="e-years"></div>
            </div>
            <div>
              <label for="stepUp">Annual Step-up in Contribution (%)</label>
              <input type="number" id="stepUp" value="0" min="0" max="50" step="1" aria-describedby="h-step">
              <div id="h-step" class="help">Increase monthly amount every year (optional).</div>
              <div class="err" id="e-step"></div>
            </div>
            <div>
              <label for="inflation">Inflation (%)</label>
              <input type="number" id="inflation" value="0" min="0" max="15" step="0.1" aria-describedby="h-infl">
              <div id="h-infl" class="help">Shows real maturity after inflation.</div>
              <div class="err" id="e-infl"></div>
            </div>
          </div>
          <div style="display:flex;gap:8px;flex-wrap:wrap;margin-top:10px">
            <button type="button" id="btnCalc" class="btn">Calculate</button>
            <button type="reset" id="btnReset" class="btn secondary">Reset</button>
            <a href="#" id="btnCSV" class="btn secondary" download="compound-schedule.csv" aria-label="Download schedule as CSV">Download CSV</a>
          </div>
        </form>
      </div>
      <div>
        <h2>Results</h2>
        <div class="kpis" aria-live="polite">
          <div class="kpi"><div class="label">Maturity Amount (FV)</div><div class="value" id="outFV">₹ 0</div></div>
          <div class="kpi"><div class="label">Total Contributions</div><div class="value" id="outContrib">₹ 0</div></div>
          <div class="kpi"><div class="label">Total Interest Earned</div><div class="value" id="outInterest">₹ 0</div></div>
          <div class="kpi"><div class="label">Real Maturity (Inflation Adjusted)</div><div class="value" id="outRealFV">₹ 0</div></div>
        </div>
        <div id="bars" aria-hidden="true">
          <div class="bar"><span id="barContrib"></span></div>
          <div class="bar green"><span id="barInterest"></span></div>
        </div>
        <div class="cta-links" style="display:flex;gap:8px;flex-wrap:wrap;margin-top:10px">
          <a href="#" class="btn secondary" data-tool="sip">SIP Calculator</a>
          <a href="#" class="btn secondary" data-tool="lumpsum">Lumpsum Calculator</a>
          <a href="#" class="btn secondary" data-tool="retirement">Retirement Calculator</a>
        </div>
      </div>
    </div>

    <div class="card" style="margin-top:16px">
      <div style="display:flex;gap:10px;align-items:center;justify-content:space-between;flex-wrap:wrap">
        <h2 style="margin:0">Schedule</h2>
        <div id="monthlyToggleWrap" style="display:none">
          <label style="font-weight:600;color:var(--blue)"><input type="checkbox" id="showMonthly" style="vertical-align:middle;margin-right:6px"> Show monthly rows (for ≤ 3 years)</label>
        </div>
      </div>
      <div id="sched-desc" style="position:absolute;left:-9999px;height:1px;width:1px;overflow:hidden">Yearly (and optional monthly) contribution vs interest schedule table with start balance, contributions, interest, and end balance.</div>
      <div class="table-wrap">
        <table id="schedule" aria-describedby="sched-desc">
          <caption>Contribution vs interest breakdown</caption>
          <thead>
            <tr>
              <th scope="col">Year</th>
              <th scope="col">Start Balance</th>
              <th scope="col">Contributions</th>
              <th scope="col">Interest</th>
              <th scope="col">End Balance</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
      <div class="pager">
        <button type="button" id="prevPage">Prev</button>
        <span id="pageInfo" aria-live="polite"></span>
        <button type="button" id="nextPage">Next</button>
      </div>
    </div>
  </section>

  <!-- 4) EXCEL FORMULAS -->
  <section id="excel" class="container">
    <div class="card">
      <h2>Excel Formulas (Copy & Paste)</h2>
      <p>Parameters: rate = annual_rate/12, nper = years*12, pmt = monthly contribution, pv = principal, type = 0 (end) or 1 (begin).</p>
      <h3>A) Future Value from Principal + Monthly Contribution</h3>
      <pre><code>=FV(rate/12, years*12, -monthly, -principal, type)
=FV(10%/12, 10*12, -5000, -100000, 0)</code></pre>
      <h3>B) Required Monthly Contribution for Target (PMT)</h3>
      <pre><code>=PMT(rate/12, years*12, -principal, target, type)
=PMT(10%/12, 120, -100000, 2500000, 0)</code></pre>
      <h3>C) Years to Reach Goal (NPER)</h3>
      <pre><code>=NPER(rate/12, -monthly, -principal, target, type) / 12
=NPER(10%/12, -5000, -100000, 2500000, 0)/12</code></pre>
      <h3>D) Solve Interest Rate from Goal (RATE)</h3>
      <pre><code>=RATE(years*12, -monthly, -principal, target, type) * 12
=RATE(120, -5000, -100000, 2500000, 0)*12</code></pre>
      <h3>E) Quarterly or Yearly Compounding</h3>
      <p>Replace 12 with 4 (quarterly) or 1 (yearly) consistently in rate and nper.</p>
      <h3>F) Beginning-of-Month Contributions</h3>
      <p>Set <code>type = 1</code> in FV/PMT/NPER/RATE for contributions at the beginning of each month.</p>
      <p><strong>Notes:</strong> Cash outflows are negative in Excel, so enter <code>-pmt</code> and <code>-pv</code> if you want positive FV. For step-up SIPs, use a year-by-year sheet with a growing PMT.</p>
    </div>
  </section>

  <!-- 5) GUIDE & EXAMPLES -->
  <section id="guide" class="container">
    <div class="card stack">
      <h2>Guide & Examples</h2>
      <h3>What is compound interest?</h3>
      <p>Compound interest grows your money because interest earns interest. APR is the nominal annual rate; actual growth depends on how often it compounds (monthly, quarterly, yearly).</p>

      <h3>Contribution timing: Begin (1) vs End (0)</h3>
      <p>With <em>beginning</em> timing (<code>type=1</code>), each payment earns an extra month of interest. It always yields a higher maturity than <em>end</em> timing for the same inputs.</p>

      <h3>Step-up contributions</h3>
      <p>Increase your monthly amount by a fixed percentage each year (e.g., +5%). The calculator applies step-up per year; in Excel, model it row-wise with a new PMT each year.</p>

      <h3>Effective Annual Rate (EAR)</h3>
      <p><code>EAR = (1 + r/m)^(m) − 1</code>, where <code>r</code> is APR and <code>m</code> is compounding frequency. Use EAR to compare products with different compounding.</p>

      <h3>Real returns with inflation</h3>
      <p><code>FV_real = FV / (1 + infl)^years</code>. This shows purchasing power adjusted for inflation.</p>

      <h3>Common mistakes</h3>
      <ul>
        <li>Mixing % and decimals (use 10%, not 0.1 in the Excel examples).</li>
        <li>Wrong signs: enter outflows as negative in Excel.</li>
        <li>Inconsistent frequencies between rate and periods.</li>
      </ul>

      <h3>Mini example (default inputs)</h3>
      <p>principal=₹1,00,000, monthly=₹5,000, rate=10%, years=10, monthly comp, end(0).</p>
      <ul>
        <li>Maturity ≈ <strong id="miniFV">₹ 0</strong></li>
        <li>Total Contributions ≈ <strong id="miniContrib">₹ 0</strong></li>
        <li>Interest ≈ <strong id="miniInterest">₹ 0</strong></li>
        <li>Year 1 End Balance ≈ <strong id="miniYear1">₹ 0</strong></li>
      </ul>
    </div>
  </section>

  <!-- 6) CTA BANNER -->
  <section class="container cta-banner">
    <div class="card" style="display:flex;align-items:center;justify-content:space-between;gap:12px;flex-wrap:wrap">
      <div>
        <h2 style="margin:0">Ready to grow faster?</h2>
        <p style="margin:4px 0 0;color:var(--muted)">Plan SIPs, try a lumpsum, or build a retirement plan.</p>
      </div>
      <div style="display:flex;gap:8px;flex-wrap:wrap">
        <a href="#" class="btn" data-tool="sip">Start a SIP</a>
        <a href="#" class="btn secondary" data-tool="lumpsum">Try Lumpsum</a>
        <a href="#" class="btn secondary" data-tool="retirement">Plan Retirement</a>
      </div>
    </div>
  </section>

  <!-- 7) FAQS -->
  <section id="faqs" class="container">
    <div class="card">
      <h2>FAQs</h2>
      <details>
        <summary>Exact Excel formula for monthly contributions (FV)</summary>
        <p>=FV(rate/12, years*12, -monthly, -principal, type)</p>
      </details>
      <details>
        <summary>PMT vs FV — when to use?</summary>
        <p>Use FV to project wealth from a known monthly amount; use PMT to solve how much to invest monthly to hit a target.</p>
      </details>
      <details>
        <summary>NPER to find years to ₹1 crore</summary>
        <p>=NPER(rate/12, -monthly, -principal, 10000000, type)/12</p>
      </details>
      <details>
        <summary>RATE to back-calc CAGR from goal</summary>
        <p>=RATE(years*12, -monthly, -principal, target, type)*12</p>
      </details>
      <details>
        <summary>Begin(1) vs End(0) timing</summary>
        <p>Begin adds before interest each month and grows faster; End adds after interest.</p>
      </details>
      <details>
        <summary>EAR vs APR and which to use</summary>
        <p>EAR includes intra-year compounding: EAR=(1+r/m)^m-1. Use EAR to compare accounts.</p>
      </details>
    </div>
  </section>

  <!-- 8) RELATED TOOLS -->
  <section class="container">
    <div class="card">
      <h2>Related Tools</h2>
      <ul style="display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:8px;list-style:none;padding:0;margin:0">
        <li><a href="#" data-tool="sip">SIP Calculator</a></li>
        <li><a href="#" data-tool="lumpsum">Lumpsum Return Calculator</a></li>
        <li><a href="#" data-tool="inflation">Inflation Calculator</a></li>
        <li><a href="#" data-tool="retirement">Retirement Calculator</a></li>
        <li><a href="#" data-tool="goal-sip">Goal SIP Planner</a></li>
      </ul>
    </div>
  </section>

  <!-- 9) FOOTER -->
  <footer class="container" style="margin:32px auto 48px">
    <div class="card" style="text-align:center">
      <p style="margin:.2rem 0;color:var(--muted)">Illustrative only; not financial advice.</p>
      <p style="margin:.2rem 0;color:#475569">© <span id="year"></span> CalculateForMe</p>
    </div>
  </footer>

  <script>
  (function(){
    const $ = (s,root=document)=>root.querySelector(s);
    const $$ = (s,root=document)=>Array.from(root.querySelectorAll(s));

    // Scroll helpers
    $('#cta-open').addEventListener('click',()=>$('#calculator').scrollIntoView({behavior:'smooth'}));
    $('#cta-excel').addEventListener('click',()=>{
      const txt = `FV (monthly)\n=FV(rate/12, years*12, -monthly, -principal, type)\nExample: =FV(10%/12, 10*12, -5000, -100000, 0)\n\nPMT for target\n=PMT(rate/12, years*12, -principal, target, type)\nExample: =PMT(10%/12, 120, -100000, 2500000, 0)\n\nNPER (years)\n=NPER(rate/12, -monthly, -principal, target, type)/12\nExample: =NPER(10%/12, -5000, -100000, 2500000, 0)/12\n\nRATE (annual)\n=RATE(years*12, -monthly, -principal, target, type)*12\nExample: =RATE(120, -5000, -100000, 2500000, 0)*12`;
      navigator.clipboard?.writeText(txt).then(()=>{
        const b = $('#cta-excel');
        const old = b.textContent; b.textContent='Copied!'; setTimeout(()=>b.textContent=old,1200);
      }).catch(()=>location.hash='#excel');
    });

    // Formatting INR
    function formatINR(num){
      const n = Math.round(Number(num)||0);
      const s = n.toString();
      const last3 = s.slice(-3);
      const other = s.slice(0,-3);
      return '₹ ' + (other?other.replace(/\B(?=(\d{2})+(?!\d))/g,',')+',':'') + last3;
    }

    // Validation rules
    const rules = {
      principal:v=>v>=0||'Must be ≥ 0',
      monthly:v=>v>=0||'Must be ≥ 0',
      rate:v=>v>=0&&v<=30||'0–30% allowed',
      years:v=>v>=0&&v<=50||'0–50 years',
      stepUp:v=>v>=0&&v<=50||'0–50% allowed',
      inflation:v=>v>=0&&v<=15||'0–15% allowed'
    };

    const els = {
      principal: $('#principal'), monthly: $('#monthly'), rate: $('#rate'), compFreq: $('#compFreq'),
      years: $('#years'), when: $('#when'), stepUp: $('#stepUp'), inflation: $('#inflation'),
      outFV: $('#outFV'), outContrib: $('#outContrib'), outInterest: $('#outInterest'), outRealFV: $('#outRealFV'),
      barContrib: $('#barContrib'), barInterest: $('#barInterest'),
      btnCalc: $('#btnCalc'), btnReset: $('#btnReset'), btnCSV: $('#btnCSV'),
      showMonthly: $('#showMonthly'), monthlyToggleWrap: $('#monthlyToggleWrap'),
      scheduleBody: $('#schedule tbody'), prevPage: $('#prevPage'), nextPage: $('#nextPage'), pageInfo: $('#pageInfo'),
      miniFV: $('#miniFV'), miniContrib: $('#miniContrib'), miniInterest: $('#miniInterest'), miniYear1: $('#miniYear1')
    };

    let hasCalculated = false;
    let scheduleRows = []; // each: {year, start, contrib, interest, end, isMonth}
    let currentPage = 1, pageSize = 300;

    function validate(){
      let ok = true;
      const vals = getValues();
      // field errors
      function setErr(id,msg){ const e = $('#e-'+id); if(e){ e.textContent = msg||''; } }
      for(const key of ['principal','monthly','rate','years','stepUp','inflation']){
        const v = vals[key];
        const r = rules[key];
        const pass = r(Number(v));
        if(pass!==true){ ok=false; setErr(key, pass); } else setErr(key,'');
      }
      els.btnCalc.disabled = !ok;
      return ok;
    }

    function getValues(){
      return {
        principal: Number(els.principal.value||0),
        monthly: Number(els.monthly.value||0),
        rate: Number(els.rate.value||0),
        compFreq: Number(els.compFreq.value||12),
        years: Number(els.years.value||0),
        when: Number(els.when.value||0),
        stepUp: Number(els.stepUp.value||0),
        inflation: Number(els.inflation.value||0)
      };
    }

    function calc(){
      if(!validate()) return;
      const {principal, monthly, rate, compFreq, years, when, stepUp, inflation} = getValues();
      const nMonths = Math.round(years*12);
      const rNom = rate/100;
      const effMonthly = Math.pow(1 + rNom/compFreq, compFreq/12) - 1; // monthly equivalent from APR & comp freq
      const step = stepUp/100;
      const whenFlag = (when===1);

      let balance = principal;
      let totalContrib = principal;
      let interestTotal = 0;

      scheduleRows = [];
      let yearStart = balance, yearContrib=0, yearInterest=0, year=1;

      for(let m=1;m<=nMonths;m++){
        const yIndex = Math.floor((m-1)/12);
        const contribThisMonth = monthly * Math.pow(1+step, yIndex);
        let before = balance;
        if(whenFlag){ balance += contribThisMonth; totalContrib += contribThisMonth; yearContrib += contribThisMonth; }
        const preInt = balance;
        balance *= (1 + effMonthly);
        const interestThisMonth = balance - preInt;
        yearInterest += interestThisMonth; interestTotal += interestThisMonth;
        if(!whenFlag){ balance += contribThisMonth; totalContrib += contribThisMonth; yearContrib += contribThisMonth; }

        // push yearly row at year end or last month
        if(m%12===0 || m===nMonths){
          const end = balance;
          scheduleRows.push({year, start: yearStart, contrib: yearContrib, interest: yearInterest, end, isMonth:false});
          year++; yearStart = balance; yearContrib=0; yearInterest=0;
        }

        // optional monthly rows will be constructed on demand (derived from monthly sim). For memory, we can store a subset only when needed.
      }

      const fv = balance;
      const realFV = inflation>0 ? fv / Math.pow(1+inflation/100, years) : fv;

      // KPIs
      els.outFV.textContent = formatINR(fv);
      els.outContrib.textContent = formatINR(totalContrib);
      els.outInterest.textContent = formatINR(fv - totalContrib);
      els.outRealFV.textContent = formatINR(realFV);

      // Bars
      const contribPct = fv>0 ? Math.max(0, Math.min(100, (totalContrib/fv)*100)) : 0;
      const interestPct = fv>0 ? 100 - contribPct : 0;
      els.barContrib.style.width = contribPct + '%';
      els.barInterest.style.width = interestPct + '%';

      // Monthly toggle visibility
      els.monthlyToggleWrap.style.display = years<=3 ? 'block' : 'none';

      // Build table (default yearly; monthly if checked)
      buildTable();

      // Mini example from first calc (defaults)
      els.miniFV.textContent = formatINR(fv);
      els.miniContrib.textContent = formatINR(totalContrib);
      els.miniInterest.textContent = formatINR(fv - totalContrib);
      if(scheduleRows.length>0){ els.miniYear1.textContent = formatINR(scheduleRows[0].end); }

      // CSV link
      makeCSV();

      hasCalculated = true;
    }

    function buildTable(){
      const {years, monthly, stepUp, when, compFreq, rate} = getValues();
      let rows = scheduleRows.map(r=>({label: 'Year '+r.year, ...r}));
      if(els.showMonthly.checked && years<=3){
        // reconstruct monthly rows re-simulating but emitting each month (keeps correct numbers)
        const nMonths = Math.round(years*12);
        const rNom = rate/100; const effMonthly = Math.pow(1 + rNom/compFreq, compFreq/12) - 1;
        const step = stepUp/100; const whenFlag = (when===1);
        let balance = Number(els.principal.value||0); let monthRows=[];
        for(let m=1;m<=nMonths;m++){
          const yIndex = Math.floor((m-1)/12); const label = `Y${yIndex+1}-M${(m-1)%12+1}`;
          const contrib = monthly * Math.pow(1+step, yIndex);
          const start = balance;
          if(whenFlag) balance += contrib;
          const pre = balance; balance *= (1+effMonthly); const interest = balance - pre;
          if(!whenFlag) balance += contrib;
          const end = balance;
          monthRows.push({label, start, contrib, interest, end});
        }
        rows = rows.flatMap((yr, i)=>{
          const startIndex = i*12; const sub = monthRows.slice(startIndex, startIndex+12);
          const yearLabel = yr.label; // keep year rows first then months
          return [{label: yearLabel, start: yr.start, contrib: yr.contrib, interest: yr.interest, end: yr.end}].concat(sub);
        });
      }

      // Pagination for large tables (>600 rows)
      const needsPaging = rows.length>600;
      currentPage = 1;
      renderPage(rows, needsPaging);

      // Hook pager
      els.prevPage.onclick = ()=>{ if(currentPage>1){ currentPage--; renderPage(rows,true); } };
      els.nextPage.onclick = ()=>{ const max = Math.ceil(rows.length/pageSize); if(currentPage<max){ currentPage++; renderPage(rows,true); } };
    }

    function renderPage(rows, paged){
      const tb = els.scheduleBody; tb.innerHTML='';
      let view = rows;
      if(paged){
        const max = Math.ceil(rows.length/pageSize);
        currentPage = Math.max(1, Math.min(currentPage, max));
        const start = (currentPage-1)*pageSize; view = rows.slice(start, start+pageSize);
        els.pageInfo.textContent = `Page ${currentPage} / ${max}`;
      } else {
        els.pageInfo.textContent = `${rows.length} rows`;
      }
      const frag = document.createDocumentFragment();
      for(const r of view){
        const tr = document.createElement('tr');
        const tds = [r.label, formatINR(r.start), formatINR(r.contrib), formatINR(r.interest), formatINR(r.end)];
        for(const cell of tds){ const td = document.createElement('td'); td.textContent = cell; tr.appendChild(td); }
        frag.appendChild(tr);
      }
      tb.appendChild(frag);
    }

    function makeCSV(){
      // Build from currently shown schedule (respect monthly toggle)
      const rows = Array.from(els.scheduleBody.querySelectorAll('tr')).map(tr=>Array.from(tr.children).map(td=>td.textContent));
      const header = ['Year','Start Balance','Contributions','Interest','End Balance'];
      const csv = [header].concat(rows).map(r=>r.join(',')).join('\r\n');
      const blob = new Blob([csv], {type: 'text/csv'});
      const url = URL.createObjectURL(blob);
      els.btnCSV.href = url;
    }

    // Events
    els.btnCalc.addEventListener('click', calc);
    els.btnReset.addEventListener('click', (e)=>{
      setTimeout(()=>{ // after reset restores defaults
        els.showMonthly.checked = false; hasCalculated=false; validate(); calc();
      }, 0);
    });
    els.showMonthly.addEventListener('change', ()=>{ if(hasCalculated) buildTable(); makeCSV(); });

    // Debounce auto-calc after first run
    let t;
    $('#calcForm').addEventListener('input', ()=>{
      validate();
      if(!hasCalculated) return;
      clearTimeout(t); t = setTimeout(()=>{ calc(); }, 200);
    });

    // Init
    document.getElementById('year').textContent = new Date().getFullYear();
    validate(); calc();
  })();
  </script>
</body>
</html>
