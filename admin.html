<!doctype html>
<html lang="en-IN">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Admin | CalculateForMe</title>
  <meta name="robots" content="noindex, nofollow">
  <style>
    :root{--blue:#0d6efd;--border:#e2e8f0;--muted:#64748b}
    body{font-family:system-ui,Segoe UI,Roboto,Arial,sans-serif;margin:0;color:#0b1220}
    header{position:sticky;top:0;background:var(--blue);color:#fff;padding:12px 16px;font-weight:800}
    .wrap{max-width:1100px;margin:16px auto;padding:0 16px;display:grid;gap:16px}
    .card{border:1px solid var(--border);border-radius:12px;padding:12px}
    input,select,textarea{width:100%;padding:.55rem;border:1px solid var(--border);border-radius:8px}
    label{font-weight:600;color:#0d6efd;display:block;margin:8px 0 4px}
    .row{display:grid;gap:12px;grid-template-columns:repeat(auto-fit,minmax(200px,1fr))}
    .btn{background:var(--blue);color:#fff;border:none;border-radius:999px;padding:.6rem 1rem;cursor:pointer}
    .btn.secondary{background:#fff;color:var(--blue);border:1px solid var(--blue)}
    table{width:100%;border-collapse:collapse}
    th,td{border-top:1px solid var(--border);padding:8px;text-align:left;font-size:14px}
    .flex{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
    #status{min-width:140px}
    #loginBox{display:flex;gap:8px;flex-wrap:wrap;align-items:end}
    @media (max-width:600px){ .row{grid-template-columns:1fr} }
  </style>
  <link href="https://cdn.jsdelivr.net/npm/quill@1.3.7/dist/quill.snow.css" rel="stylesheet">
</head>
<body>
  <header>CalculateForMe â€” Admin</header>
  <main class="wrap">
    <section class="card">
      <h2>Login</h2>
      <div id="loginBox">
        <div>
          <label>Username<input id="username" autocomplete="username"></label>
        </div>
        <div>
          <label>Password<input id="password" type="password" autocomplete="current-password"></label>
        </div>
        <button class="btn" id="btnLogin">Login</button>
        <button class="btn secondary" id="btnLogout">Logout</button>
        <span id="authMsg" style="color:#16a34a;font-weight:600"></span>
      </div>
    </section>

    <section class="card">
      <h2>New / Edit Post</h2>
      <div class="row">
        <div>
          <label>Title<input id="title"></label>
        </div>
        <div>
          <label>Slug<input id="slug"></label>
        </div>
        <div>
          <label>Excerpt<textarea id="excerpt" rows="2"></textarea></label>
        </div>
        <div>
          <label>Tags (comma separated)<input id="tags"></label>
        </div>
        <div>
          <label>Meta Title<input id="metaTitle"></label>
        </div>
        <div>
          <label>Meta Description<textarea id="metaDescription" rows="2"></textarea></label>
        </div>
        <div>
          <label>Status<select id="status"><option value="draft">Draft</option><option value="published">Publish</option></select></label>
        </div>
      </div>
      <div class="flex" style="margin:8px 0">
        <input type="file" id="coverFile" accept="image/*">
        <button class="btn secondary" id="btnUpload">Upload Cover</button>
        <span id="coverUrl" class="muted"></span>
      </div>
      <div id="editor" style="height:280px"></div>
      <div class="flex" style="margin-top:10px">
        <button class="btn" id="btnSave">Save</button>
        <button class="btn secondary" id="btnNew">New</button>
        <span id="saveMsg" style="color:#16a34a;font-weight:600"></span>
      </div>
    </section>

    <section class="card">
      <div class="flex" style="justify-content:space-between">
        <h2>Posts</h2>
        <button class="btn secondary" id="btnRefresh">Refresh</button>
      </div>
      <table>
        <thead><tr><th>Title</th><th>Slug</th><th>Status</th><th>Updated</th><th>Actions</th></tr></thead>
        <tbody id="postsBody"></tbody>
      </table>
    </section>
  </main>

  <script src="https://cdn.jsdelivr.net/npm/quill@1.3.7/dist/quill.min.js"></script>
  <script>
    const API = '/api';
    const tokenKey = 'cfm_jwt';
    const $ = (s, root=document)=>root.querySelector(s);

    const quill = new Quill('#editor', { theme: 'snow' });

    function getToken(){ return localStorage.getItem(tokenKey)||''; }
    function setToken(t){ localStorage.setItem(tokenKey, t); }
    function authHdr(){ const t=getToken(); return t? { 'Authorization': 'Bearer '+t } : {}; }

    async function login(){
      const username = $('#username').value.trim();
      const password = $('#password').value;
      const r = await fetch(API+'/login', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({username,password}) });
      const j = await r.json();
      if(r.ok){ setToken(j.token); $('#authMsg').textContent='Logged in'; } else { alert(j.error||'Login failed'); }
    }

    async function uploadCover(){
      const f = $('#coverFile').files[0]; if(!f){ alert('Choose a file'); return; }
      const fd = new FormData(); fd.append('file', f);
      const r = await fetch(API+'/upload', { method:'POST', headers: authHdr(), body: fd });
      const j = await r.json(); if(r.ok){ $('#coverUrl').textContent = j.url; } else alert(j.error||'Upload failed');
    }

    function collectData(){
      return {
        title: $('#title').value.trim(),
        slug: $('#slug').value.trim(),
        excerpt: $('#excerpt').value.trim(),
        tags: $('#tags').value.trim(),
        metaTitle: $('#metaTitle').value.trim(),
        metaDescription: $('#metaDescription').value.trim(),
        coverImage: $('#coverUrl').textContent.trim(),
        status: $('#status').value,
        content: quill.root.innerHTML
      };
    }

    let editingId = null;

    async function save(){
      const data = collectData();
      const method = editingId? 'PUT':'POST';
      const url = editingId? (API+'/posts/'+editingId) : (API+'/posts');
      const r = await fetch(url, { method, headers: { 'Content-Type':'application/json', ...authHdr() }, body: JSON.stringify(data) });
      const j = await r.json();
      if(r.ok){ $('#saveMsg').textContent='Saved'; editingId = j._id; loadPosts(); setTimeout(()=>$('#saveMsg').textContent='',1500); }
      else alert(j.error||'Save failed');
    }

    function clearForm(){ editingId=null; ['title','slug','excerpt','tags','metaTitle','metaDescription'].forEach(id=>$('#'+id).value=''); $('#coverUrl').textContent=''; $('#status').value='draft'; quill.root.innerHTML=''; }

    async function loadPosts(){
      const r = await fetch(API+'/posts'); const posts = await r.json();
      const tb = $('#postsBody'); tb.innerHTML='';
      posts.forEach(p=>{
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${p.title}</td><td>${p.slug}</td><td>${p.status}</td><td>${new Date(p.updatedAt).toLocaleString()}</td>
          <td><button class='btn secondary' data-id='${p._id}' data-act='edit'>Edit</button> <button class='btn' data-id='${p._id}' data-act='del'>Delete</button></td>`;
        tb.appendChild(tr);
      });
    }

    async function handleTable(e){
      const btn = e.target.closest('button'); if(!btn) return;
      const id = btn.getAttribute('data-id'); const act = btn.getAttribute('data-act');
      if(act==='edit'){
        const r = await fetch(API+'/posts/'+id); const p = await r.json();
        editingId = p._id; $('#title').value=p.title; $('#slug').value=p.slug; $('#excerpt').value=p.excerpt||''; $('#tags').value=(p.tags||[]).join(','); $('#metaTitle').value=p.metaTitle||''; $('#metaDescription').value=p.metaDescription||''; $('#coverUrl').textContent=p.coverImage||''; $('#status').value=p.status; quill.root.innerHTML=p.content||'';
      } else if(act==='del'){
        if(!confirm('Delete this post?')) return;
        const r = await fetch(API+'/posts/'+id, { method:'DELETE', headers: authHdr() });
        if(r.ok) loadPosts(); else alert('Delete failed');
      }
    }

    $('#btnLogin').onclick = login;
    $('#btnLogout').onclick = ()=>{ localStorage.removeItem(tokenKey); $('#authMsg').textContent='Logged out'; };
    $('#btnUpload').onclick = uploadCover;
    $('#btnSave').onclick = save;
    $('#btnNew').onclick = clearForm;
    $('#btnRefresh').onclick = loadPosts;
    $('#postsBody').addEventListener('click', handleTable);

    loadPosts();
  </script>
</body>
</html>
